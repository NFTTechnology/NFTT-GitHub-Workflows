name: 3AI Issue Analyzer - Reusable

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number
      issue_title:
        description: 'Issue title'
        required: true
        type: string
      issue_body:
        description: 'Issue body'
        required: true
        type: string
      comment_id:
        description: 'Comment ID that triggered the analysis'
        required: false
        type: number
      repository:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      OPENAI_API_KEY:
        required: true
      GEMINI_API_KEY:
        required: true
      GITHUB_TOKEN:
        required: false
        description: 'GitHub token for API calls (defaults to github.token)'
    outputs:
      analysis_report:
        description: '3AI analysis report'
        value: ${{ jobs.analyze.outputs.report }}

jobs:
  analyze:
    runs-on: ubuntu-latest
    outputs:
      report: ${{ steps.save-analysis.outputs.report }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install anthropic openai google-generativeai python-dotenv
      
      - name: Add Reaction
        if: inputs.comment_id
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN || github.token }}
          script: |
            const [owner, repo] = '${{ inputs.repository }}'.split('/');
            await github.rest.reactions.createForIssueComment({
              owner: owner,
              repo: repo,
              comment_id: ${{ inputs.comment_id }},
              content: 'rocket'
            });
      
      - name: Run 3AI Issue Analysis
        id: run-analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ISSUE_TITLE: ${{ inputs.issue_title }}
          ISSUE_BODY: ${{ inputs.issue_body }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          cat > analyze_issue.py << 'EOF'
          import os
          import anthropic
          import openai
          import google.generativeai as genai
          import json
          import sys
          
          # Issueæƒ…å ±ã‚’å–å¾—
          issue_title = os.getenv('ISSUE_TITLE', '')
          issue_body = os.getenv('ISSUE_BODY', '')
          issue_number = os.getenv('ISSUE_NUMBER', '')
          
          print(f"ğŸ¤– 3AI Issue Analysis for #{issue_number}")
          print(f"Title: {issue_title}")
          print("=" * 50)
          
          # Phase 1: Claude - è¦ä»¶åˆ†æã¨å®Ÿè£…è¨ˆç”»
          try:
              claude_client = anthropic.Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))
              
              planning_prompt = f"""
              ä»¥ä¸‹ã®Issueã‚’åˆ†æã—ã¦ã€å®Ÿè£…è¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ï¼š
              
              Issue #{issue_number}: {issue_title}
              
              å†…å®¹ï¼š
              {issue_body}
              
              ä»¥ä¸‹ã®è¦³ç‚¹ã§åˆ†æã—ã¦ãã ã•ã„ï¼š
              1. è¦ä»¶ã®æ˜ç¢ºåŒ–ï¼ˆä¸æ˜ç‚¹ãŒã‚ã‚Œã°æŒ‡æ‘˜ï¼‰
              2. æŠ€è¡“çš„ãªå®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
              3. å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´
              4. å®Ÿè£…ã®å„ªå…ˆé †ä½
              5. æ½œåœ¨çš„ãªãƒªã‚¹ã‚¯
              
              æ—¥æœ¬èªã§å…·ä½“çš„ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
              """
              
              claude_response = claude_client.messages.create(
                  model="claude-3-5-sonnet-20241022",
                  max_tokens=1500,
                  messages=[{"role": "user", "content": planning_prompt}]
              )
              
              claude_analysis = claude_response.content[0].text
              print("ğŸ“‹ Claude - è¦ä»¶åˆ†æå®Œäº†")
              
          except Exception as e:
              print(f"Claude error: {e}")
              claude_analysis = "è¦ä»¶åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
          
          # Phase 2: Gemini - æŠ€è¡“çš„å®Ÿç¾å¯èƒ½æ€§ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
          try:
              genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
              gemini_model = genai.GenerativeModel('gemini-2.0-flash-exp')
              
              gemini_prompt = f"""
              Issue #{issue_number}: {issue_title}
              
              å†…å®¹ï¼š
              {issue_body}
              
              ä»¥ä¸‹ã®æŠ€è¡“çš„è¦³ç‚¹ã‹ã‚‰åˆ†æã—ã¦ãã ã•ã„ï¼š
              1. å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¨å¥¨
              2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®è€ƒæ…®äº‹é …
              3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ³¨æ„ç‚¹
              4. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥
              5. é¡ä¼¼å®Ÿè£…ã®å‚è€ƒä¾‹
              
              å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æ—¥æœ¬èªã§æä¾›ã—ã¦ãã ã•ã„ã€‚
              """
              
              gemini_response = gemini_model.generate_content(gemini_prompt)
              gemini_analysis = gemini_response.text
              print("ğŸ” Gemini - æŠ€è¡“åˆ†æå®Œäº†")
              
          except Exception as e:
              print(f"Gemini error: {e}")
              gemini_analysis = "æŠ€è¡“åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
          
          # Phase 3: OpenAI - UXã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥
          try:
              openai.api_key = os.getenv("OPENAI_API_KEY")
              client = openai.OpenAI()
              
              ux_prompt = f"""
              Issue #{issue_number}: {issue_title}
              
              å†…å®¹ï¼š
              {issue_body}
              
              ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã—ã¦ãã ã•ã„ï¼š
              1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¸ã®å½±éŸ¿
              2. UIã®æ”¹å–„ææ¡ˆ
              3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¿…è¦æ€§
              4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ç¯„å›²
              5. ç§»è¡Œè¨ˆç”»ï¼ˆå¿…è¦ãªå ´åˆï¼‰
              
              é–‹ç™ºè€…ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸¡æ–¹ã®è¦–ç‚¹ã‹ã‚‰ã€åˆ†ã‹ã‚Šã‚„ã™ã„æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
              """
              
              openai_response = client.chat.completions.create(
                  model="gpt-4",
                  messages=[{"role": "user", "content": ux_prompt}],
                  max_tokens=1000
              )
              
              ux_analysis = openai_response.choices[0].message.content
              print("ğŸ’¡ OpenAI - UXåˆ†æå®Œäº†")
              
          except Exception as e:
              print(f"OpenAI error: {e}")
              ux_analysis = "UXåˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
          
          # Phase 4: Claude - çµ±åˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
          try:
              final_prompt = f"""
              Issue #{issue_number}: {issue_title} ã«ã¤ã„ã¦ã€3AIã®åˆ†æçµæœã‚’çµ±åˆã—ã¦ãã ã•ã„ã€‚
              
              Claudeã®è¦ä»¶åˆ†æï¼š
              {claude_analysis}
              
              Geminiã®æŠ€è¡“åˆ†æï¼š
              {gemini_analysis}
              
              OpenAIã®UXåˆ†æï¼š
              {ux_analysis}
              
              ã“ã‚Œã‚‰ã‚’çµ±åˆã—ã¦ã€ä»¥ä¸‹ã®å½¢å¼ã§å®Ÿè£…ææ¡ˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
              
              ## ğŸ“‹ è¦ä»¶ã‚µãƒãƒªãƒ¼
              ï¼ˆè¦ä»¶ã®ç†è§£ã¨æ˜ç¢ºåŒ–ï¼‰
              
              ## ğŸ›  å®Ÿè£…è¨ˆç”»
              ï¼ˆå…·ä½“çš„ãªå®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
              
              ## âš ï¸ æ³¨æ„äº‹é …
              ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ãã®ä»–ã®è€ƒæ…®äº‹é …ï¼‰
              
              ## ğŸ“Š å½±éŸ¿ç¯„å›²
              ï¼ˆå¤‰æ›´ã®å½±éŸ¿ã‚’å—ã‘ã‚‹éƒ¨åˆ†ï¼‰
              
              ## âœ… ãƒ†ã‚¹ãƒˆè¨ˆç”»
              ï¼ˆå¿…è¦ãªãƒ†ã‚¹ãƒˆã®æ¦‚è¦ï¼‰
              
              ## ğŸ’¡ è¿½åŠ ææ¡ˆ
              ï¼ˆæ”¹å–„æ¡ˆã‚„ä»£æ›¿æ¡ˆï¼‰
              
              é–‹ç™ºè€…ãŒå®Ÿè£…ã‚’é–‹å§‹ã§ãã‚‹å…·ä½“çš„ãªå†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚
              """
              
              final_response = claude_client.messages.create(
                  model="claude-3-5-sonnet-20241022",
                  max_tokens=2000,
                  messages=[{"role": "user", "content": final_prompt}]
              )
              
              final_report = final_response.content[0].text
              
              # ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
              with open('issue_analysis.txt', 'w', encoding='utf-8') as f:
                  f.write(f"# ğŸ¤– 3AI Issue Analysis Report\n\n")
                  f.write(f"**Issue #{issue_number}: {issue_title}**\n\n")
                  f.write(final_report)
                  f.write("\n\n---\n### ğŸ¤ 3AIå”èª¿åˆ†æ\n\n")
                  f.write("- ğŸ“‹ **Claude**: è¦ä»¶åˆ†æãƒ»å®Ÿè£…è¨ˆç”»ãƒ»çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ\n")
                  f.write("- ğŸ” **Gemini**: æŠ€è¡“åˆ†æãƒ»ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹\n")
                  f.write("- ğŸ’¡ **OpenAI**: UXåˆ†æãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥\n\n")
                  f.write("*Powered by [NFTT-GitHub-Workflows](https://github.com/NFTTechnology/NFTT-GitHub-Workflows)*")
              
              print("\nâœ… 3AIåˆ†æå®Œäº†")
              
          except Exception as e:
              print(f"Final integration error: {e}")
              with open('issue_analysis.txt', 'w', encoding='utf-8') as f:
                  f.write(f"## âš ï¸ åˆ†æã‚¨ãƒ©ãƒ¼\n\n3AIåˆ†æã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: {str(e)}")
          EOF
          
          python analyze_issue.py
      
      - name: Save Analysis Output
        id: save-analysis
        run: |
          if [ -f issue_analysis.txt ]; then
            # GitHub Outputã«ä¿å­˜ï¼ˆãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
            echo "report<<EOF" >> $GITHUB_OUTPUT
            cat issue_analysis.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "report=åˆ†æçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_OUTPUT
          fi
      
      - name: Post Analysis Result
        if: inputs.issue_number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN || github.token }}
          script: |
            const fs = require('fs');
            let analysis = '';
            
            try {
              analysis = fs.readFileSync('issue_analysis.txt', 'utf8');
            } catch (e) {
              analysis = '## âš ï¸ åˆ†æçµæœã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼\n\nåˆ†æçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
            }
            
            if (analysis.trim()) {
              const [owner, repo] = '${{ inputs.repository }}'.split('/');
              await github.rest.issues.createComment({
                owner: owner,
                repo: repo,
                issue_number: ${{ inputs.issue_number }},
                body: analysis
              });
            }