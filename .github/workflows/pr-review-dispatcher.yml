name: PR Review Dispatcher Template

# ã“ã‚Œã¯å„ãƒªãƒã‚¸ãƒˆãƒªã§ä½¿ç”¨ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã™
# .github/workflows/pr-auto-review.yml ã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„

on:
  pull_request:
    types: [opened, synchronize]
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PRç•ªå·ï¼ˆæ‰‹å‹•å®Ÿè¡Œæ™‚ï¼‰'
        required: true
        type: number
      review_version:
        description: 'ä½¿ç”¨ã™ã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³'
        required: false
        default: 'v1'
        type: choice
        options:
          - v1  # ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ
          - v2  # ãƒãƒ«ãƒãƒ­ãƒ¼ãƒ«ç‰ˆ
      review_type:
        description: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ·±ã•'
        required: false
        default: 'balanced'
        type: choice
        options:
          - quick
          - balanced
          - detailed

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  trigger-review:
    runs-on: ubuntu-latest
    steps:
      - name: Determine PR number
        id: pr
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "version=${{ inputs.review_version }}" >> $GITHUB_OUTPUT
            echo "type=${{ inputs.review_type }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            # è‡ªå‹•å®Ÿè¡Œæ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            # ãƒ©ãƒ™ãƒ«ã«åŸºã¥ã„ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ±ºå®š
            if [[ "${{ contains(github.event.pull_request.labels.*.name, 'complex-pr') }}" == "true" ]]; then
              echo "version=v2" >> $GITHUB_OUTPUT
              echo "type=detailed" >> $GITHUB_OUTPUT
            else
              echo "version=v1" >> $GITHUB_OUTPUT
              echo "type=balanced" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Post start message
        uses: actions/github-script@v7
        with:
          script: |
            const pr_number = ${{ steps.pr.outputs.number }};
            const version = '${{ steps.pr.outputs.version }}';
            const type = '${{ steps.pr.outputs.type }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: `ğŸ¤– AI Code Review ã‚’é–‹å§‹ã—ã¾ã™...\n- Version: ${version}\n- Type: ${type}`
            });

  # v1ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
  review-v1:
    needs: trigger-review
    if: needs.trigger-review.outputs.version == 'v1' || needs.trigger-review.outputs.version == ''
    uses: NFTTechnology/NFTT-GitHub-Workflows/.github/workflows/reusable-pr-review-v1.yml@main
    with:
      pr_number: ${{ needs.trigger-review.outputs.number }}
      repository: ${{ github.repository }}
      review_type: ${{ needs.trigger-review.outputs.type || 'balanced' }}
      max_diff_lines: 5000
    secrets: inherit

  # v2ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆãƒãƒ«ãƒãƒ­ãƒ¼ãƒ«ç‰ˆï¼‰
  review-v2:
    needs: trigger-review
    if: needs.trigger-review.outputs.version == 'v2'
    uses: NFTTechnology/NFTT-GitHub-Workflows/.github/workflows/reusable-pr-review-v2.yml@main
    with:
      pr_number: ${{ needs.trigger-review.outputs.number }}
      repository: ${{ github.repository }}
      review_type: ${{ needs.trigger-review.outputs.type || 'balanced' }}
      max_diff_lines: 10000
      enable_code_suggestions: true
    secrets: inherit