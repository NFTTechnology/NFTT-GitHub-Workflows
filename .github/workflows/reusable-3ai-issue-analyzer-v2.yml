name: 3AI Issue Analyzer v2 (Base64)

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number
      issue_title:
        description: 'Issue title'
        required: true
        type: string
      issue_body:
        description: 'Issue body'
        required: true
        type: string
      repository:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
      comment_id:
        description: 'Comment ID that triggered the analysis'
        required: false
        type: number
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      OPENAI_API_KEY:
        required: true
      GEMINI_API_KEY:
        required: true
    outputs:
      analysis_report:
        description: '3AI analysis report (base64 encoded)'
        value: ${{ jobs.analyze.outputs.report }}
      analysis_report_decoded:
        description: '3AI analysis report (decoded)'
        value: ${{ jobs.decode.outputs.report_decoded }}

jobs:
  analyze:
    runs-on: ubuntu-latest
    outputs:
      report: ${{ steps.save-analysis.outputs.report }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install anthropic openai google-generativeai
      
      - name: React to comment
        if: inputs.comment_id
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ inputs.comment_id }},
              content: 'rocket'
            });
      
      - name: Run 3AI Issue Analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat > analyze_issue.py << 'EOF'
          import os
          import anthropic
          import openai
          import google.generativeai as genai
          from datetime import datetime
          
          # Issueæƒ…å ±
          issue_number = "${{ inputs.issue_number }}"
          issue_title = """${{ inputs.issue_title }}"""
          issue_body = """${{ inputs.issue_body }}"""
          
          print(f"ğŸ” 3AIåˆ†æé–‹å§‹: Issue #{issue_number}")
          print("=" * 50)
          
          try:
              # Phase 1: Claude - æ¦‚è¦ã¨å®Ÿè£…ææ¡ˆ
              claude_client = anthropic.Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))
              
              claude_prompt = f"""
              Issue #{issue_number}: {issue_title}
              
              å†…å®¹ï¼š
              {issue_body}
              
              ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã—ã¦ãã ã•ã„ï¼š
              1. å•é¡Œã®æœ¬è³ªçš„ãªç†è§£
              2. æŠ€è¡“çš„ãªèª²é¡Œã¨è§£æ±ºã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
              3. å®Ÿè£…ã®å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—
              4. æ½œåœ¨çš„ãªãƒªã‚¹ã‚¯ã¨å¯¾ç­–
              5. æˆåŠŸåŸºæº–ã®æ˜ç¢ºåŒ–
              
              é–‹ç™ºè€…ãŒå®Ÿè£…ã‚’é–‹å§‹ã§ãã‚‹å…·ä½“çš„ãªææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚
              """
              
              print("ğŸ¤– Claudeåˆ†æä¸­...")
              claude_response = claude_client.messages.create(
                  model="claude-3-5-sonnet-20241022",
                  max_tokens=2000,
                  messages=[{"role": "user", "content": claude_prompt}]
              )
              claude_analysis = claude_response.content[0].text
              print("âœ… Claudeåˆ†æå®Œäº†")
              
              # Phase 2: Gemini - æŠ€è¡“è©³ç´°ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
              genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
              model = genai.GenerativeModel('gemini-1.5-flash')
              
              gemini_prompt = f"""
              Issue #{issue_number}: {issue_title}
              
              å†…å®¹ï¼š
              {issue_body}
              
              Claudeã®åˆ†æï¼š
              {claude_analysis}
              
              ä»¥ä¸‹ã®æŠ€è¡“çš„è¦³ç‚¹ã‹ã‚‰è©³ç´°ãªåˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
              1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è€ƒæ…®äº‹é …
              2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿
              3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¦³ç‚¹
              4. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥
              5. æ¥­ç•Œã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
              6. ä»£æ›¿å®Ÿè£…æ¡ˆã®æ¤œè¨
              """
              
              print("ğŸ”® Geminiåˆ†æä¸­...")
              gemini_response = model.generate_content(gemini_prompt)
              gemini_analysis = gemini_response.text
              print("âœ… Geminiåˆ†æå®Œäº†")
              
          except Exception as e:
              print(f"Gemini error: {e}")
              gemini_analysis = "æŠ€è¡“åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
          
          # Phase 3: OpenAI - UXã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥
          try:
              openai.api_key = os.getenv("OPENAI_API_KEY")
              client = openai.OpenAI()
              
              ux_prompt = f"""
              Issue #{issue_number}: {issue_title}
              
              å†…å®¹ï¼š
              {issue_body}
              
              ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã—ã¦ãã ã•ã„ï¼š
              1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¸ã®å½±éŸ¿
              2. UIã®æ”¹å–„ææ¡ˆ
              3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¿…è¦æ€§
              4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ç¯„å›²
              5. ç§»è¡Œè¨ˆç”»ï¼ˆå¿…è¦ãªå ´åˆï¼‰
              """
              
              print("ğŸ¨ OpenAIåˆ†æä¸­...")
              openai_response = client.chat.completions.create(
                  model="gpt-4",
                  messages=[{"role": "user", "content": ux_prompt}],
                  max_tokens=1500
              )
              openai_analysis = openai_response.choices[0].message.content
              print("âœ… OpenAIåˆ†æå®Œäº†")
              
          except Exception as e:
              print(f"OpenAI error: {e}")
              openai_analysis = "UXåˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
          
          # Phase 4: çµ±åˆåˆ†æ
          try:
              final_prompt = f"""
              Issue #{issue_number}: {issue_title}
              
              3ã¤ã®AIã«ã‚ˆã‚‹åˆ†æçµæœï¼š
              
              **Claudeï¼ˆæ¦‚è¦ãƒ»å®Ÿè£…ææ¡ˆï¼‰**ï¼š
              {claude_analysis}
              
              **Geminiï¼ˆæŠ€è¡“è©³ç´°ï¼‰**ï¼š
              {gemini_analysis}
              
              **OpenAIï¼ˆUXãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰**ï¼š
              {openai_analysis}
              
              ã“ã‚Œã‚‰ã‚’çµ±åˆã—ã¦ã€ä»¥ä¸‹ã®å½¢å¼ã§å®Ÿè£…ææ¡ˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
              
              ## ğŸ“‹ è¦ä»¶ã‚µãƒãƒªãƒ¼
              ï¼ˆè¦ä»¶ã®ç†è§£ã¨æ˜ç¢ºåŒ–ï¼‰
              
              ## ğŸ›  å®Ÿè£…è¨ˆç”»
              ï¼ˆå…·ä½“çš„ãªå®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
              
              ## âš ï¸ æ³¨æ„äº‹é …
              ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ãã®ä»–ã®è€ƒæ…®äº‹é …ï¼‰
              
              ## ğŸ“Š å½±éŸ¿ç¯„å›²
              ï¼ˆå¤‰æ›´ã®å½±éŸ¿ã‚’å—ã‘ã‚‹éƒ¨åˆ†ï¼‰
              
              ## âœ… ãƒ†ã‚¹ãƒˆè¨ˆç”»
              ï¼ˆå¿…è¦ãªãƒ†ã‚¹ãƒˆã®æ¦‚è¦ï¼‰
              
              ## ğŸ’¡ è¿½åŠ ææ¡ˆ
              ï¼ˆæ”¹å–„æ¡ˆã‚„ä»£æ›¿æ¡ˆï¼‰
              
              é–‹ç™ºè€…ãŒå®Ÿè£…ã‚’é–‹å§‹ã§ãã‚‹å…·ä½“çš„ãªå†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚
              """
              
              final_response = claude_client.messages.create(
                  model="claude-3-5-sonnet-20241022",
                  max_tokens=2000,
                  messages=[{"role": "user", "content": final_prompt}]
              )
              
              # æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
              with open('issue_analysis.txt', 'w', encoding='utf-8') as f:
                  f.write(f"# ğŸ¤– 3AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ: Issue #{issue_number}\n\n")
                  f.write(f"**Issue**: {issue_title}\n")
                  f.write(f"**Repository**: ${{ inputs.repository }}\n")
                  f.write(f"**åˆ†ææ—¥æ™‚**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
                  f.write("---\n\n")
                  f.write(final_response.content[0].text)
                  f.write("\n\n---\n\n")
                  f.write("## ğŸ” å„AIã®å€‹åˆ¥åˆ†æ\n\n")
                  f.write("<details>\n<summary>è©³ç´°ã‚’è¡¨ç¤º</summary>\n\n")
                  f.write("### Claudeåˆ†æ\n")
                  f.write(claude_analysis + "\n\n")
                  f.write("### Geminiåˆ†æ\n")
                  f.write(gemini_analysis + "\n\n")
                  f.write("### OpenAIåˆ†æ\n")
                  f.write(openai_analysis + "\n\n")
                  f.write("</details>\n\n")
                  f.write("---\n\n")
                  f.write("- ğŸ¤– **Claude**: æ¦‚è¦ç†è§£ãƒ»å®Ÿè£…ææ¡ˆ\n")
                  f.write("- ğŸ”® **Gemini**: æŠ€è¡“è©³ç´°ãƒ»ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹\n")
                  f.write("- ğŸ’¡ **OpenAI**: UXåˆ†æãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥\n\n")
                  f.write("*Powered by [NFTT-GitHub-Workflows](https://github.com/NFTTechnology/NFTT-GitHub-Workflows)*")
              
              print("\nâœ… 3AIåˆ†æå®Œäº†")
              
          except Exception as e:
              print(f"Final integration error: {e}")
              with open('issue_analysis.txt', 'w', encoding='utf-8') as f:
                  f.write(f"## âš ï¸ åˆ†æã‚¨ãƒ©ãƒ¼\n\n3AIåˆ†æã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: {str(e)}")
          EOF
          
          python analyze_issue.py
      
      - name: Save Analysis Output
        id: save-analysis
        run: |
          if [ -f issue_analysis.txt ]; then
            # Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ä¿å­˜ï¼ˆæ”¹è¡Œã‚„EOFå•é¡Œã‚’å›é¿ï¼‰
            ENCODED_REPORT=$(base64 -w 0 issue_analysis.txt)
            echo "report=$ENCODED_REPORT" >> $GITHUB_OUTPUT
            echo "âœ… åˆ†æçµæœã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ"
          else
            echo "report=" >> $GITHUB_OUTPUT
            echo "âŒ åˆ†æçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
  
  decode:
    needs: analyze
    runs-on: ubuntu-latest
    outputs:
      report_decoded: ${{ steps.decode.outputs.report_decoded }}
    steps:
      - name: Decode analysis report
        id: decode
        run: |
          if [ -n "${{ needs.analyze.outputs.report }}" ]; then
            # Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
            echo "${{ needs.analyze.outputs.report }}" | base64 -d > decoded_report.txt
            
            # ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸå†…å®¹ã‚’å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            echo "ğŸ“ ãƒ‡ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸåˆ†æãƒ¬ãƒãƒ¼ãƒˆ:"
            cat decoded_report.txt
            
            # ãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å‡ºåŠ›ï¼ˆã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ï¼‰
            {
              echo 'report_decoded<<EOF_DECODED_REPORT'
              cat decoded_report.txt
              echo 'EOF_DECODED_REPORT'
            } >> $GITHUB_OUTPUT
          else
            echo "report_decoded=åˆ†æçµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_OUTPUT
          fi
      
      - name: Post Analysis Result
        if: inputs.issue_number && needs.analyze.outputs.report != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('decoded_report.txt', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              body: report
            });