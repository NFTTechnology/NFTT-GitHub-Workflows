name: Reusable PR Review v1.1 (Debug Enhanced)

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'PRç•ªå·'
        required: true
        type: string
      repository:
        description: 'ãƒªãƒã‚¸ãƒˆãƒªå (owner/repo)'
        required: true
        type: string
      review_type:
        description: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒ— (quick/balanced/detailed)'
        required: false
        type: string
        default: 'balanced'
      max_diff_lines:
        description: 'å·®åˆ†ã®æœ€å¤§è¡Œæ•°'
        required: false
        type: number
        default: 5000
      models:
        description: 'ä½¿ç”¨ã™ã‚‹AIãƒ¢ãƒ‡ãƒ«è¨­å®šï¼ˆJSONï¼‰'
        required: false
        type: string
        default: '{"claude": "claude-3-5-sonnet-20241022", "openai": "gpt-4o-mini"}'
      debug_mode:
        description: 'ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰'
        required: false
        type: boolean
        default: true

jobs:
  pr-review-enhanced:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic openai PyGithub requests

      - name: Get PR information with debug
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Fetching PR #${{ inputs.pr_number }} from ${{ inputs.repository }}"
          
          # PRæƒ…å ±ã‚’å–å¾—
          gh pr view ${{ inputs.pr_number }} \
            --repo ${{ inputs.repository }} \
            --json number,title,body,author,createdAt,additions,deletions,files,labels \
            > pr_data.json
          
          # å·®åˆ†ã‚’å–å¾—ï¼ˆæœ€å¤§è¡Œæ•°ã¾ã§ï¼‰
          gh pr diff ${{ inputs.pr_number }} \
            --repo ${{ inputs.repository }} \
            | head -n ${{ inputs.max_diff_lines }} > pr_diff.txt || true
          
          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±
          echo "ğŸ“Š PR Statistics:"
          echo "- Title: $(jq -r '.title' pr_data.json)"
          echo "- Changes: +$(jq -r '.additions' pr_data.json) -$(jq -r '.deletions' pr_data.json)"
          echo "- Files: $(jq -r '.files | length' pr_data.json)"
          echo "- Diff size: $(wc -l < pr_diff.txt) lines / $(wc -c < pr_diff.txt) chars"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã®çµ±è¨ˆ
          echo "ğŸ“ Changed files:"
          jq -r '.files[] | "- \(.path) (+\(.additions) -\(.deletions))"' pr_data.json
          
          # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œå‡º
          echo "ğŸ” Source code files detected:"
          jq -r '.files[].path' pr_data.json | grep -E '\.(js|ts|py|java|go|rb|php|cs|cpp|c)$' || echo "No source files found"

      - name: Run enhanced AI review
        id: ai-review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODELS_CONFIG: ${{ inputs.models }}
          REVIEW_TYPE: ${{ inputs.review_type }}
          DEBUG_MODE: ${{ inputs.debug_mode }}
        run: |
          cat > pr_review_enhanced.py << 'PYTHON_SCRIPT'
          import os
          import json
          import re
          import anthropic
          import openai
          
          # è¨­å®šèª­ã¿è¾¼ã¿
          models = json.loads(os.getenv('MODELS_CONFIG'))
          review_type = os.getenv('REVIEW_TYPE', 'balanced')
          debug_mode = os.getenv('DEBUG_MODE', 'true').lower() == 'true'
          
          # PRæƒ…å ±èª­ã¿è¾¼ã¿
          with open('pr_data.json', 'r') as f:
              pr_data = json.load(f)
          
          # å·®åˆ†èª­ã¿è¾¼ã¿
          try:
              with open('pr_diff.txt', 'r') as f:
                  diff_content = f.read()
          except:
              diff_content = "å·®åˆ†ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®šç¾©
          security_patterns = {
              'password_plain': r'password\s*[:=]\s*["\']?[^"\'\s]+|password\s*[:=]\s*\w+(?!\s*\.)(?!\s*hash)',
              'sql_injection': r'(SELECT|INSERT|UPDATE|DELETE).*\+.*["\']|f["\'].*{.*}.*WHERE',
              'hardcoded_secret': r'(api_key|secret|token)\s*[:=]\s*["\'][^"\']+["\']',
              'unsafe_eval': r'eval\s*\(|exec\s*\(',
              'no_auth': r'@app\.route.*\n(?!.*@(auth|login)_required)',
          }
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—åˆ¥ã®é‡è¦åº¦
          file_priorities = {
              '.js': 'high',
              '.ts': 'high',
              '.py': 'high',
              '.java': 'high',
              '.go': 'high',
              '.rb': 'high',
              '.php': 'high',
              '.yml': 'medium',
              '.yaml': 'medium',
              '.json': 'low',
              '.md': 'low'
          }
          
          # PRæƒ…å ±ã®æ•´ç†
          pr_number = pr_data.get('number', 'N/A')
          pr_title = pr_data.get('title', 'No title')
          pr_body = pr_data.get('body', 'No description')
          pr_author = pr_data.get('author', {}).get('login', 'Unknown')
          additions = pr_data.get('additions', 0)
          deletions = pr_data.get('deletions', 0)
          files = pr_data.get('files', [])
          
          # ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ
          source_files = []
          config_files = []
          other_files = []
          
          for file in files:
              path = file.get('path', '')
              ext = os.path.splitext(path)[1]
              priority = file_priorities.get(ext, 'low')
              
              file_info = {
                  'path': path,
                  'additions': file.get('additions', 0),
                  'deletions': file.get('deletions', 0),
                  'priority': priority
              }
              
              if priority == 'high':
                  source_files.append(file_info)
              elif priority == 'medium':
                  config_files.append(file_info)
              else:
                  other_files.append(file_info)
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚§ãƒƒã‚¯
          security_issues = []
          for pattern_name, pattern in security_patterns.items():
              matches = re.findall(pattern, diff_content, re.IGNORECASE | re.MULTILINE)
              if matches:
                  security_issues.append({
                      'type': pattern_name,
                      'count': len(matches),
                      'samples': matches[:2]  # æœ€åˆã®2ã¤ã®ã‚µãƒ³ãƒ—ãƒ«
                  })
          
          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®å‡ºåŠ›
          if debug_mode:
              print("=== DEBUG INFO ===")
              print(f"Source files: {len(source_files)}")
              print(f"Config files: {len(config_files)}")
              print(f"Other files: {len(other_files)}")
              print(f"Security patterns found: {len(security_issues)}")
              for issue in security_issues:
                  print(f"- {issue['type']}: {issue['count']} occurrences")
              print("==================")
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®š
          review_config = {
              'quick': {
                  'focus': 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã¨ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªãƒã‚°ã®ã¿',
                  'max_tokens': 800,
                  'checklist': ['é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ', 'æ˜ã‚‰ã‹ãªãƒã‚°', 'ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã®å¯èƒ½æ€§']
              },
              'balanced': {
                  'focus': 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒã‚°ã€ä¸»è¦ãªæ”¹å–„ç‚¹',
                  'max_tokens': 1500,
                  'checklist': ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§', 'ãƒã‚°ã¨ã‚¨ãƒ©ãƒ¼', 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹', 'ã‚³ãƒ¼ãƒ‰å“è³ª']
              },
              'detailed': {
                  'focus': 'åŒ…æ‹¬çš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼',
                  'max_tokens': 2500,
                  'checklist': ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'ãƒã‚°', 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹', 'ã‚³ãƒ¼ãƒ‰å“è³ª', 
                               'ãƒ†ã‚¹ãƒˆ', 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ', 'ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹', 'ä¿å®ˆæ€§']
              }
          }
          
          config = review_config[review_type]
          
          # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¸­å¿ƒã®å·®åˆ†æŠ½å‡º
          source_diff = ""
          if source_files:
              for file in source_files:
                  file_pattern = rf"diff --git.*{re.escape(file['path'])}.*?(?=diff --git|$)"
                  file_diff = re.search(file_pattern, diff_content, re.DOTALL)
                  if file_diff:
                      source_diff += file_diff.group(0) + "\n\n"
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæ”¹å–„ç‰ˆï¼‰
          prompt = f"""
          ä»¥ä¸‹ã®PRã‚’ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚³ãƒ¼ãƒ‰å“è³ªã®è¦³ç‚¹ã‹ã‚‰å³å¯†ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
          
          ## é‡è¦: å¿…ãšç¢ºèªã™ã¹ãã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³
          ä»¥ä¸‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¦‹ã¤ã‘ãŸå ´åˆã¯å¿…ãšæŒ‡æ‘˜ã—ã¦ãã ã•ã„ï¼š
          1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¹³æ–‡ä¿å­˜ï¼ˆpassword: <å€¤> ã®å½¢å¼ï¼‰
          2. SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ–‡å­—åˆ—çµåˆã§ã®SQLæ§‹ç¯‰ï¼‰
          3. ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±
          4. ä¸é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆ-1ãƒã‚§ãƒƒã‚¯ãªã—ç­‰ï¼‰
          5. å®‰å…¨ã§ãªã„é–¢æ•°ã®ä½¿ç”¨ï¼ˆeval, execç­‰ï¼‰
          
          ## PRæƒ…å ±
          - ã‚¿ã‚¤ãƒˆãƒ«: {pr_title}
          - å¤‰æ›´: +{additions} -{deletions} ({len(files)} files)
          - ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«æ•°: {len(source_files)}
          
          ## æ¤œå‡ºã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³
          {chr(10).join(f"- {issue['type']}: {issue['count']}ä»¶æ¤œå‡º" for issue in security_issues) if security_issues else "è‡ªå‹•æ¤œå‡ºãªã—ï¼ˆç›®è¦–ç¢ºèªå¿…è¦ï¼‰"}
          
          ## ä¸»è¦ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´
          {source_diff[:10000] if source_diff else "ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãªã—"}
          
          ## ãã®ä»–ã®å·®åˆ†
          {diff_content[:5000] if not source_diff else "ï¼ˆçœç•¥ï¼‰"}
          
          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡ç¤º
          ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒ—: {review_type} - {config['focus']}
          ãƒã‚§ãƒƒã‚¯é …ç›®: {', '.join(config['checklist'])}
          
          å‡ºåŠ›å½¢å¼:
          ## ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ
          ï¼ˆæ¤œå‡ºã•ã‚ŒãŸå ´åˆã€å…·ä½“çš„ãªè¡Œç•ªå·ã¨ã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å«ã‚ã¦ï¼‰
          
          ## âš ï¸ ãƒã‚°ãƒ»å“è³ªå•é¡Œ
          ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç­‰ï¼‰
          
          ## ğŸ’¡ æ”¹å–„ææ¡ˆ
          ï¼ˆã‚ˆã‚Šè‰¯ã„å®Ÿè£…æ–¹æ³•ï¼‰
          
          ## âœ… è‰¯ã„ç‚¹
          ï¼ˆ1-2å€‹ï¼‰
          
          å¿…ãšå®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’å¼•ç”¨ã—ã¦å…·ä½“çš„ã«æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚
          """
          
          # AIå®Ÿè¡Œï¼ˆClaudeã‚’å„ªå…ˆï¼‰
          try:
              client = anthropic.Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))
              response = client.messages.create(
                  model=models['claude'],
                  max_tokens=config['max_tokens'],
                  temperature=0.2,  # ã‚ˆã‚Šæ±ºå®šçš„ãªå‡ºåŠ›
                  messages=[{"role": "user", "content": prompt}]
              )
              review_content = response.content[0].text
          except Exception as e:
              # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: OpenAI
              try:
                  client = openai.OpenAI(api_key=os.getenv('OPENAI_API_KEY'))
                  response = client.chat.completions.create(
                      model=models['openai'],
                      max_tokens=config['max_tokens'],
                      temperature=0.2,
                      messages=[{"role": "user", "content": prompt}]
                  )
                  review_content = response.choices[0].message.content
              except Exception as e2:
                  review_content = f"ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: {e}, {e2}"
          
          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å«ã‚€ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ
          debug_info = ""
          if debug_mode:
              debug_info = f"""
          <details>
          <summary>ğŸ” Debug Information</summary>
          
          - Source files reviewed: {len(source_files)}
          - Security patterns detected: {len(security_issues)}
          - Diff size: {len(diff_content)} chars
          - Source diff extracted: {len(source_diff)} chars
          
          </details>
          
          """
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®æ•´å½¢
          review_report = f"""# ğŸ¤– AI Code Review (v1.1 Debug)
          
          **PR:** #{pr_number} {pr_title}
          **Type:** {review_type.title()}
          **Files:** {len(source_files)} source, {len(config_files)} config, {len(other_files)} other
          
          {review_content}
          
          ---
          {debug_info}
          <sub>ğŸ¤– Enhanced review by AI ({models['claude']} / {models['openai']}) | [Powered by NFTT-GitHub-Workflows](https://github.com/NFTTechnology/NFTT-GitHub-Workflows)</sub>
          """
          
          # çµæœã‚’ä¿å­˜
          with open('review_report.md', 'w', encoding='utf-8') as f:
              f.write(review_report)
          
          print("Enhanced review completed successfully")
          PYTHON_SCRIPT
          
          python pr_review_enhanced.py

      - name: Post review comment
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          if [[ -f "review_report.md" ]]; then
            REPORT=$(cat review_report.md)
            
            # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            gh pr comment ${{ inputs.pr_number }} \
              --repo ${{ inputs.repository }} \
              --body "$REPORT"
            
            echo "âœ… Enhanced review posted successfully"
          else
            echo "âŒ Review report not found"
            exit 1
          fi

      - name: Add review labels
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã®ãƒ©ãƒ™ãƒ«è¿½åŠ 
          if grep -q "ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ" review_report.md; then
            gh pr edit ${{ inputs.pr_number }} \
              --repo ${{ inputs.repository }} \
              --add-label "security-issue" || true
          fi
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆã¿ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          gh pr edit ${{ inputs.pr_number }} \
            --repo ${{ inputs.repository }} \
            --add-label "ai-reviewed" || true