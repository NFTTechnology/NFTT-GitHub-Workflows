name: Reusable PR Review v1 (Simple)

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'PRç•ªå·'
        required: true
        type: string
      repository:
        description: 'ãƒªãƒã‚¸ãƒˆãƒªå (owner/repo)'
        required: true
        type: string
      review_type:
        description: 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒ— (quick/balanced/detailed)'
        required: false
        type: string
        default: 'balanced'
      max_diff_lines:
        description: 'å·®åˆ†ã®æœ€å¤§è¡Œæ•°'
        required: false
        type: number
        default: 5000
      models:
        description: 'ä½¿ç”¨ã™ã‚‹AIãƒ¢ãƒ‡ãƒ«è¨­å®šï¼ˆJSONï¼‰'
        required: false
        type: string
        default: '{"claude": "claude-3-5-sonnet-20241022", "openai": "gpt-4o-mini"}'

jobs:
  pr-review:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic openai PyGithub requests

      - name: Get PR information
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching PR #${{ inputs.pr_number }} from ${{ inputs.repository }}"
          
          # PRæƒ…å ±ã‚’å–å¾—
          gh pr view ${{ inputs.pr_number }} \
            --repo ${{ inputs.repository }} \
            --json title,body,author,createdAt,additions,deletions,files,labels \
            > pr_data.json
          
          # å·®åˆ†ã‚’å–å¾—ï¼ˆæœ€å¤§è¡Œæ•°ã¾ã§ï¼‰
          gh pr diff ${{ inputs.pr_number }} \
            --repo ${{ inputs.repository }} \
            | head -n ${{ inputs.max_diff_lines }} > pr_diff.txt || true
          
          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±
          echo "PR data:"
          jq -r '.title' pr_data.json
          echo "Diff size: $(wc -l < pr_diff.txt) lines"

      - name: Run AI review
        id: ai-review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODELS_CONFIG: ${{ inputs.models }}
          REVIEW_TYPE: ${{ inputs.review_type }}
        run: |
          cat > pr_review.py << 'PYTHON_SCRIPT'
          import os
          import json
          import anthropic
          import openai
          
          # è¨­å®šèª­ã¿è¾¼ã¿
          models = json.loads(os.getenv('MODELS_CONFIG'))
          review_type = os.getenv('REVIEW_TYPE', 'balanced')
          
          # PRæƒ…å ±èª­ã¿è¾¼ã¿
          with open('pr_data.json', 'r') as f:
              pr_data = json.load(f)
          
          # å·®åˆ†èª­ã¿è¾¼ã¿
          try:
              with open('pr_diff.txt', 'r') as f:
                  diff_content = f.read()
          except:
              diff_content = "å·®åˆ†ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ·±ã•è¨­å®š
          review_config = {
              'quick': {
                  'focus': 'critical issues only',
                  'max_tokens': 500,
                  'checklist': ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ', 'æ˜ã‚‰ã‹ãªãƒã‚°']
              },
              'balanced': {
                  'focus': 'important issues and improvements',
                  'max_tokens': 1000,
                  'checklist': ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'ãƒã‚°', 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹', 'ã‚³ãƒ¼ãƒ‰å“è³ª']
              },
              'detailed': {
                  'focus': 'comprehensive review',
                  'max_tokens': 2000,
                  'checklist': ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'ãƒã‚°', 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹', 'ã‚³ãƒ¼ãƒ‰å“è³ª', 
                               'ãƒ†ã‚¹ãƒˆ', 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ', 'ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹']
              }
          }
          
          config = review_config[review_type]
          
          # PRæƒ…å ±ã®æ•´ç†
          pr_title = pr_data.get('title', 'No title')
          pr_body = pr_data.get('body', 'No description')
          pr_author = pr_data.get('author', {}).get('login', 'Unknown')
          additions = pr_data.get('additions', 0)
          deletions = pr_data.get('deletions', 0)
          files = pr_data.get('files', [])
          labels = [label['name'] for label in pr_data.get('labels', [])]
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
          prompt = f"""
          ä»¥ä¸‹ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
          ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒ—: {review_type} - {config['focus']}
          
          PRæƒ…å ±:
          - ã‚¿ã‚¤ãƒˆãƒ«: {pr_title}
          - ä½œè€…: {pr_author}
          - å¤‰æ›´: +{additions} -{deletions} ({len(files)} files)
          - ãƒ©ãƒ™ãƒ«: {', '.join(labels) if labels else 'ãªã—'}
          
          èª¬æ˜:
          {pr_body[:1000]}
          
          å¤‰æ›´å†…å®¹:
          {diff_content[:8000]}
          
          ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„:
          {chr(10).join(f'- {item}' for item in config['checklist'])}
          
          å‡ºåŠ›å½¢å¼:
          ## ğŸ“Š ç·åˆè©•ä¾¡
          [æ‰¿èªå¯èƒ½ / æ¡ä»¶ä»˜ãæ‰¿èª / è¦ä¿®æ­£] - ç°¡æ½”ãªç†ç”±
          
          ## ğŸš¨ å¿…é ˆä¿®æ­£äº‹é …
          ï¼ˆã‚ã‚Œã°ç®‡æ¡æ›¸ãã§ã€ã‚³ãƒ¼ãƒ‰ä¾‹ä»˜ãï¼‰
          
          ## ğŸ’¡ æ”¹å–„ææ¡ˆ
          ï¼ˆã‚ã‚Œã°ç®‡æ¡æ›¸ãã§ã€å„ªå…ˆåº¦ä»˜ãï¼‰
          
          ## âœ… è‰¯ã„ç‚¹
          ï¼ˆ1-2å€‹ã€ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å‘ä¸Šã®ãŸã‚ï¼‰
          
          ç°¡æ½”ã§å®Ÿç”¨çš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚
          """
          
          # AIå®Ÿè¡Œï¼ˆClaudeã‚’å„ªå…ˆï¼‰
          try:
              client = anthropic.Anthropic(api_key=os.getenv('ANTHROPIC_API_KEY'))
              response = client.messages.create(
                  model=models['claude'],
                  max_tokens=config['max_tokens'],
                  temperature=0.3,
                  messages=[{"role": "user", "content": prompt}]
              )
              review_content = response.content[0].text
          except Exception as e:
              # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: OpenAI
              try:
                  client = openai.OpenAI(api_key=os.getenv('OPENAI_API_KEY'))
                  response = client.chat.completions.create(
                      model=models['openai'],
                      max_tokens=config['max_tokens'],
                      temperature=0.3,
                      messages=[{"role": "user", "content": prompt}]
                  )
                  review_content = response.choices[0].message.content
              except Exception as e2:
                  review_content = f"ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: {e}, {e2}"
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®æ•´å½¢
          review_report = f"""# ğŸ¤– AI Code Review
          
          **PR:** #{pr_data.get('number', 'N/A')} {pr_title}
          **ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒ—:** {review_type.title()}
          
          {review_content}
          
          ---
          <sub>ğŸ¤– Reviewed by AI ({models['claude']} / {models['openai']}) | [Powered by NFTT-GitHub-Workflows](https://github.com/NFTTechnology/NFTT-GitHub-Workflows)</sub>
          """
          
          # çµæœã‚’ä¿å­˜
          with open('review_report.md', 'w', encoding='utf-8') as f:
              f.write(review_report)
          
          print("Review completed successfully")
          PYTHON_SCRIPT
          
          python pr_review.py

      - name: Post review comment
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          if [[ -f "review_report.md" ]]; then
            REPORT=$(cat review_report.md)
            
            # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            gh pr comment ${{ inputs.pr_number }} \
              --repo ${{ inputs.repository }} \
              --body "$REPORT"
            
            echo "âœ… Review posted successfully"
          else
            echo "âŒ Review report not found"
            exit 1
          fi

      - name: Add review labels
        if: success() && contains(fromJSON('["balanced", "detailed"]'), inputs.review_type)
        env:
          GH_TOKEN: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¸ˆã¿ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          gh pr edit ${{ inputs.pr_number }} \
            --repo ${{ inputs.repository }} \
            --add-label "ai-reviewed" || true