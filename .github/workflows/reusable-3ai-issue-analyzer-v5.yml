name: 3AI Issue Analyzer v5 (Cost Optimized)

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number
      issue_title:
        description: 'Issue title'
        required: true
        type: string
      issue_body:
        description: 'Issue body'
        required: true
        type: string
      repository:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
      comment_id:
        description: 'Comment ID that triggered the analysis'
        required: false
        type: number
      include_comments:
        description: 'Include comment history in analysis'
        required: false
        type: boolean
        default: true
      max_comments:
        description: 'Maximum number of recent comments to include'
        required: false
        type: number
        default: 30
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      OPENAI_API_KEY:
        required: true
      GEMINI_API_KEY:
        required: true
    outputs:
      analysis_report:
        description: '3AI analysis report'
        value: ${{ jobs.analyze.outputs.report }}

jobs:
  analyze:
    runs-on: ubuntu-latest
    outputs:
      report: ${{ steps.post-result.outputs.report }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get comment history
        id: get-comments
        if: inputs.include_comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              per_page: ${{ inputs.max_comments }}
            });
            
            // æœ€æ–°ã®ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰å–å¾—
            const commentHistory = comments.data.reverse().map(comment => ({
              author: comment.user.login,
              created_at: comment.created_at,
              body: comment.body
            }));
            
            // ã‚³ãƒ¡ãƒ³ãƒˆå±¥æ­´ã‚’JSONå½¢å¼ã§ä¿å­˜
            core.setOutput('comments_json', JSON.stringify(commentHistory));
            console.log(`Found ${commentHistory.length} comments`);
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install anthropic openai google-generativeai
      
      - name: React to comment
        if: inputs.comment_id
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ inputs.comment_id }},
              content: 'rocket'
            });
      
      - name: Run 3AI Issue Analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COMMENTS_JSON: ${{ steps.get-comments.outputs.comments_json }}
        run: |
          cat > analyze_issue.py << 'PYTHON_SCRIPT'
          import os
          import json
          import anthropic
          import openai
          import google.generativeai as genai
          from datetime import datetime
          
          # Issueæƒ…å ±
          issue_number = "${{ inputs.issue_number }}"
          issue_title = """${{ inputs.issue_title }}"""
          issue_body = """${{ inputs.issue_body }}"""
          
          print(f"ðŸ” 3AIåˆ†æžé–‹å§‹: Issue #{issue_number}")
          print("=" * 50)
          
          # ã‚³ãƒ¡ãƒ³ãƒˆå±¥æ­´ã‚’å–å¾—
          comments_json = os.getenv("COMMENTS_JSON", "[]")
          comments = json.loads(comments_json) if comments_json else []
          
          # Phase 0: ã‚³ãƒ¡ãƒ³ãƒˆè¦ç´„ï¼ˆå®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ã§å®Ÿæ–½ï¼‰
          summary_context = ""
          if comments:
              print(f"ðŸ“ {len(comments)}ä»¶ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦ç´„ä¸­...")
              
              # Claude Haikuã§è¦ç´„ï¼ˆå®‰ä¾¡ï¼‰
              try:
                  claude_client = anthropic.Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))
                  
                  # ã‚³ãƒ¡ãƒ³ãƒˆå±¥æ­´ã‚’æ•´å½¢
                  comments_text = ""
                  for comment in comments:
                      comments_text += f"@{comment['author']} ({comment['created_at']}):\n{comment['body']}\n\n---\n\n"
                  
                  summary_prompt = f"""
                  ä»¥ä¸‹ã®Issueã®ã‚³ãƒ¡ãƒ³ãƒˆå±¥æ­´ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã€æ±ºå®šäº‹é …ã€æŠ€è¡“çš„ãªè­°è«–ã‚’ä¸­å¿ƒã«ã¾ã¨ã‚ã¦ãã ã•ã„ï¼š
                  
                  # Issue: {issue_title}
                  
                  ## ã‚³ãƒ¡ãƒ³ãƒˆå±¥æ­´
                  {comments_text}
                  
                  ä»¥ä¸‹ã®å½¢å¼ã§è¦ç´„ã—ã¦ãã ã•ã„ï¼š
                  - ä¸»è¦ãªè­°è«–ãƒã‚¤ãƒ³ãƒˆ
                  - åˆæ„ã•ã‚ŒãŸäº‹é …
                  - æœªè§£æ±ºã®èª²é¡Œ
                  - æŠ€è¡“çš„ãªææ¡ˆã‚„æ‡¸å¿µäº‹é …
                  """
                  
                  # Claude Haikuï¼ˆå®‰ä¾¡ï¼‰ã‚’ä½¿ç”¨
                  summary_response = claude_client.messages.create(
                      model="claude-3-haiku-20240307",
                      max_tokens=1000,
                      messages=[{"role": "user", "content": summary_prompt}]
                  )
                  summary_context = f"\n\n## ðŸ’¬ è­°è«–ã®è¦ç´„\n{summary_response.content[0].text}"
                  print("âœ… ã‚³ãƒ¡ãƒ³ãƒˆè¦ç´„å®Œäº†ï¼ˆClaude Haikuä½¿ç”¨ï¼‰")
                  
              except Exception as e:
                  print(f"è¦ç´„ã‚¨ãƒ©ãƒ¼: {e}")
                  # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç”Ÿã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¸€éƒ¨å«ã‚ã‚‹
                  recent_comments = "\n\n## ðŸ’¬ æœ€æ–°ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè¦ç´„å¤±æ•—ï¼‰\n"
                  for comment in comments[:5]:  # æœ€æ–°5ä»¶ã®ã¿
                      recent_comments += f"@{comment['author']}: {comment['body'][:200]}...\n\n"
                  summary_context = recent_comments
          
          # åˆ†æžç”¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æº–å‚™
          analysis_context = f"""
          # Issue #{issue_number}: {issue_title}
          
          ## ðŸ“ Issueæœ¬æ–‡
          {issue_body}
          {summary_context}
          """
          
          try:
              # Phase 1: Claude Sonnet - æ¦‚è¦ã¨å®Ÿè£…ææ¡ˆï¼ˆé«˜æ€§èƒ½ãƒ¢ãƒ‡ãƒ«ï¼‰
              claude_client = anthropic.Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))
              
              claude_prompt = f"""
              ä»¥ä¸‹ã®Issueã‚’åˆ†æžã—ã¦ãã ã•ã„ï¼š
              
              {analysis_context}
              
              ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åˆ†æžã—ã¦ãã ã•ã„ï¼š
              1. å•é¡Œã®æœ¬è³ªçš„ãªç†è§£ï¼ˆè¦ç´„ã•ã‚ŒãŸè­°è«–ã‚‚è€ƒæ…®ï¼‰
              2. æŠ€è¡“çš„ãªèª²é¡Œã¨è§£æ±ºã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
              3. å®Ÿè£…ã®å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—
              4. æ½œåœ¨çš„ãªãƒªã‚¹ã‚¯ã¨å¯¾ç­–
              5. æˆåŠŸåŸºæº–ã®æ˜Žç¢ºåŒ–
              
              é–‹ç™ºè€…ãŒå®Ÿè£…ã‚’é–‹å§‹ã§ãã‚‹å…·ä½“çš„ãªææ¡ˆã‚’ã—ã¦ãã ã•ã„ã€‚
              """
              
              print("ðŸ¤– Claude Sonnetåˆ†æžä¸­...")
              claude_response = claude_client.messages.create(
                  model="claude-3-5-sonnet-20241022",
                  max_tokens=2000,
                  messages=[{"role": "user", "content": claude_prompt}]
              )
              claude_analysis = claude_response.content[0].text
              print("âœ… Claudeåˆ†æžå®Œäº†")
              
              # Phase 2: Gemini Flash - æŠ€è¡“è©³ç´°ï¼ˆé«˜é€Ÿãƒ»å®‰ä¾¡ï¼‰
              genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
              model = genai.GenerativeModel('gemini-1.5-flash')
              
              gemini_prompt = f"""
              ä»¥ä¸‹ã®Issueã‚’æŠ€è¡“çš„è¦³ç‚¹ã‹ã‚‰åˆ†æžã—ã¦ãã ã•ã„ï¼š
              
              {analysis_context}
              
              Claudeã®åˆ†æžï¼š
              {claude_analysis}
              
              ä»¥ä¸‹ã®æŠ€è¡“çš„è¦³ç‚¹ã‹ã‚‰è©³ç´°ãªåˆ†æžã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
              1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è€ƒæ…®äº‹é …
              2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã¸ã®å½±éŸ¿
              3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¦³ç‚¹
              4. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥
              5. å®Ÿè£…ã®æŠ€è¡“çš„ãªæ³¨æ„ç‚¹
              """
              
              print("ðŸ”® Gemini Flashåˆ†æžä¸­...")
              gemini_response = model.generate_content(gemini_prompt)
              gemini_analysis = gemini_response.text
              print("âœ… Geminiåˆ†æžå®Œäº†")
              
          except Exception as e:
              print(f"Gemini error: {e}")
              gemini_analysis = "æŠ€è¡“åˆ†æžã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
          
          # Phase 3: GPT-3.5 - UXã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆå®‰ä¾¡ï¼‰
          try:
              openai.api_key = os.getenv("OPENAI_API_KEY")
              client = openai.OpenAI()
              
              ux_prompt = f"""
              ä»¥ä¸‹ã®Issueã‚’UXè¦³ç‚¹ã‹ã‚‰åˆ†æžã—ã¦ãã ã•ã„ï¼š
              
              {analysis_context}
              
              ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰åˆ†æžã—ã¦ãã ã•ã„ï¼š
              1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã¸ã®å½±éŸ¿
              2. UIã®æ”¹å–„ææ¡ˆ
              3. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å¿…è¦æ€§
              4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ç¯„å›²
              """
              
              print("ðŸŽ¨ GPT-3.5åˆ†æžä¸­...")
              # GPT-3.5ã‚’ä½¿ç”¨ï¼ˆå®‰ä¾¡ï¼‰
              openai_response = client.chat.completions.create(
                  model="gpt-3.5-turbo",
                  messages=[{"role": "user", "content": ux_prompt}],
                  max_tokens=1500
              )
              openai_analysis = openai_response.choices[0].message.content
              print("âœ… OpenAIåˆ†æžå®Œäº†")
              
          except Exception as e:
              print(f"OpenAI error: {e}")
              openai_analysis = "UXåˆ†æžã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
          
          # Phase 4: Claude Haikuã§çµ±åˆï¼ˆå®‰ä¾¡ï¼‰
          try:
              final_prompt = f"""
              3ã¤ã®AIã«ã‚ˆã‚‹åˆ†æžçµæžœã‚’çµ±åˆã—ã¦ã€é–‹ç™ºè€…å‘ã‘ã®å®Ÿè£…ææ¡ˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š
              
              Claudeåˆ†æž: {claude_analysis[:1000]}...
              Geminiåˆ†æž: {gemini_analysis[:1000]}...
              OpenAIåˆ†æž: {openai_analysis[:1000]}...
              
              ç°¡æ½”ã§å®Ÿç”¨çš„ãªææ¡ˆã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
              """
              
              # Claude Haikuã§çµ±åˆï¼ˆå®‰ä¾¡ï¼‰
              final_response = claude_client.messages.create(
                  model="claude-3-haiku-20240307",
                  max_tokens=2000,
                  messages=[{"role": "user", "content": final_prompt}]
              )
              
              # æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
              with open('issue_analysis.txt', 'w', encoding='utf-8') as f:
                  f.write(f"# ðŸ¤– 3AIåˆ†æžãƒ¬ãƒãƒ¼ãƒˆ: Issue #{issue_number}\n\n")
                  f.write(f"**Issue**: {issue_title}\n")
                  f.write(f"**Repository**: ${{ inputs.repository }}\n")
                  f.write(f"**åˆ†æžæ—¥æ™‚**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                  if comments:
                      f.write(f"**ã‚³ãƒ¡ãƒ³ãƒˆæ•°**: {len(comments)}ä»¶ï¼ˆè¦ç´„æ¸ˆã¿ï¼‰\n")
                  f.write("\n---\n\n")
                  f.write(final_response.content[0].text)
                  f.write("\n\n---\n\n")
                  f.write("## ðŸ’° ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã•ã‚ŒãŸåˆ†æž\n\n")
                  f.write("- ðŸ“ **è¦ç´„**: Claude Haikuï¼ˆå®‰ä¾¡ï¼‰\n")
                  f.write("- ðŸ¤– **ãƒ¡ã‚¤ãƒ³åˆ†æž**: Claude Sonnetï¼ˆé«˜æ€§èƒ½ï¼‰\n")
                  f.write("- ðŸ”® **æŠ€è¡“åˆ†æž**: Gemini Flashï¼ˆé«˜é€Ÿãƒ»å®‰ä¾¡ï¼‰\n")
                  f.write("- ðŸŽ¨ **UXåˆ†æž**: GPT-3.5ï¼ˆå®‰ä¾¡ï¼‰\n")
                  f.write("- ðŸ”„ **çµ±åˆ**: Claude Haikuï¼ˆå®‰ä¾¡ï¼‰\n\n")
                  f.write("*Powered by [NFTT-GitHub-Workflows](https://github.com/NFTTechnology/NFTT-GitHub-Workflows)*")
              
              print("\nâœ… 3AIåˆ†æžå®Œäº†ï¼ˆã‚³ã‚¹ãƒˆæœ€é©åŒ–ç‰ˆï¼‰")
              
          except Exception as e:
              print(f"Final integration error: {e}")
              with open('issue_analysis.txt', 'w', encoding='utf-8') as f:
                  f.write(f"## âš ï¸ åˆ†æžã‚¨ãƒ©ãƒ¼\n\n3AIåˆ†æžã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: {str(e)}")
          PYTHON_SCRIPT
          
          python analyze_issue.py
      
      - name: Post Analysis Result
        id: post-result
        if: inputs.issue_number
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            if (!fs.existsSync('issue_analysis.txt')) {
              console.error('âŒ åˆ†æžçµæžœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              core.setOutput('report', 'åˆ†æžçµæžœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              return;
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
            const report = fs.readFileSync('issue_analysis.txt', 'utf8');
            
            // Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.issue_number }},
              body: report
            });
            
            // å‡ºåŠ›ã¨ã—ã¦ä¿å­˜ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ï¼‰
            const escapedReport = report.replace(/"/g, '\\"').replace(/\n/g, '\\n');
            core.setOutput('report', escapedReport);
            
            console.log('âœ… åˆ†æžçµæžœã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');