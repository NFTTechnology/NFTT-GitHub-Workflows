# çµ±åˆAIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ  - Issue/PRä¸¡å¯¾å¿œ
---
name: AI Review System

on:
  workflow_dispatch:
    inputs:
      issue-number:
        required: true
        type: string
        description: "Issue or PR number to review"
      review-type:
        required: false
        type: choice
        description: "Type of review"
        default: 'auto'
        options:
          - auto      # è‡ªå‹•åˆ¤å®š
          - issue     # Issueç”¨ãƒ¬ãƒ“ãƒ¥ãƒ¼
          - pr        # PRç”¨è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼
      priority:
        required: false
        type: choice
        description: "Review priority"
        default: 'normal'
        options:
          - high
          - normal
          - low

  workflow_call:
    inputs:
      issue-number:
        required: true
        type: string
      review-type:
        required: false
        type: string
        default: 'auto'
      priority:
        required: false
        type: string
        default: 'normal'

concurrency:
  group: ai-review-${{ inputs.issue-number }}-${{ inputs.priority }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  pull-requests: write
  id-token: write

env:
  # AIãƒ¢ãƒ‡ãƒ«è¨­å®š
  ANTHROPIC_MODEL: claude-3-5-sonnet-20241022
  OPENAI_MODEL: gpt-4o-mini
  ANTHROPIC_TEMPERATURE: 0.3
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼ˆPRã®å ´åˆã¯è‡ªå‹•çš„ã«å¢—åŠ ï¼‰
  ANTHROPIC_MAX_TOKENS: 2000

defaults:
  run:
    shell: bash

jobs:
  prepare-review:
    runs-on: ubuntu-latest
    outputs:
      is-pr: ${{ steps.check-type.outputs.is-pr }}
      max-tokens: ${{ steps.check-type.outputs.max-tokens }}
      review-mode: ${{ steps.check-type.outputs.review-mode }}
    steps:
      - name: Check review type
        id: check-type
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Issue/PRåˆ¤å®šã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰è¨­å®š
          ISSUE_NUM="${{ inputs.issue-number }}"
          REVIEW_TYPE="${{ inputs.review-type }}"
          
          echo "Checking #$ISSUE_NUM with review type: $REVIEW_TYPE"
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒ—ãŒæ˜ç¤ºçš„ã«PRã¨æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
          if [[ "$REVIEW_TYPE" == "pr" ]]; then
            IS_PR="true"
            REVIEW_MODE="pr"
            MAX_TOKENS="4000"
            echo "Forced PR mode for #$ISSUE_NUM"
          elif [[ "$REVIEW_TYPE" == "issue" ]]; then
            IS_PR="false"
            REVIEW_MODE="issue"
            MAX_TOKENS="2000"
            echo "Forced Issue mode for #$ISSUE_NUM"
          else
            # auto mode - PRå­˜åœ¨ãƒã‚§ãƒƒã‚¯
            echo "Auto-detecting type for #$ISSUE_NUM"
            
            # ã¾ãšPRã¨ã—ã¦å–å¾—ã‚’è©¦ã¿ã‚‹
            if gh pr view $ISSUE_NUM --repo ${{ github.repository }} --json number >/dev/null 2>&1; then
              IS_PR="true"
              REVIEW_MODE="pr"
              MAX_TOKENS="4000"
              echo "Auto-detected as PR #$ISSUE_NUM"
            else
              # æ¬¡ã«Issueã¨ã—ã¦ç¢ºèª
              if gh issue view $ISSUE_NUM --repo ${{ github.repository }} --json number >/dev/null 2>&1; then
                IS_PR="false"
                REVIEW_MODE="issue"
                MAX_TOKENS="2000"
                echo "Auto-detected as Issue #$ISSUE_NUM"
              else
                echo "Error: #$ISSUE_NUM not found as PR or Issue"
                exit 1
              fi
            fi
          fi
          
          echo "is-pr=$IS_PR" >> $GITHUB_OUTPUT
          echo "max-tokens=$MAX_TOKENS" >> $GITHUB_OUTPUT
          echo "review-mode=$REVIEW_MODE" >> $GITHUB_OUTPUT
          
          echo "Final decision: IS_PR=$IS_PR, REVIEW_MODE=$REVIEW_MODE, MAX_TOKENS=$MAX_TOKENS"

  ai-multi-role-review:
    needs: prepare-review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install anthropic openai PyGithub requests

      - name: Get review context
        id: context
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUM="${{ inputs.issue-number }}"
          IS_PR="${{ needs.prepare-review.outputs.is-pr }}"
          
          echo "Fetching context for #$ISSUE_NUM (is PR: $IS_PR)"
          
          if [[ "$IS_PR" == "true" ]]; then
            # PRæƒ…å ±ã®å–å¾—
            echo "Fetching PR data..."
            gh pr view $ISSUE_NUM --repo ${{ github.repository }} --json title,body,url,author,createdAt,additions,deletions,files > pr_data.json || {
              echo "Error: Failed to fetch PR data"
              exit 1
            }
            
            # ãƒ‡ãƒãƒƒã‚°ç”¨: PRæƒ…å ±ã®ç¢ºèª
            echo "PR data fetched successfully:"
            jq -r '.title' pr_data.json
            
            # å·®åˆ†å–å¾—ï¼ˆæœ€å¤§10000è¡Œï¼‰
            echo "Fetching PR diff..."
            gh pr diff $ISSUE_NUM --repo ${{ github.repository }} | head -n 10000 > diff.txt || {
              echo "Warning: Failed to fetch PR diff, creating empty file"
              touch diff.txt
            }
            
            # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
            echo "Extracting changed files..."
            if jq -r '.files[].path' pr_data.json > changed_files.txt 2>/dev/null; then
              echo "Changed files: $(wc -l < changed_files.txt) files"
            else
              echo "Warning: No files found in PR data"
              touch changed_files.txt
            fi
            
            echo "context-type=pr" >> $GITHUB_OUTPUT
          else
            # Issueæƒ…å ±ã®å–å¾—
            echo "Fetching Issue data..."
            gh issue view $ISSUE_NUM --repo ${{ github.repository }} --json title,body,url,author,createdAt,comments > issue_data.json || {
              echo "Error: Failed to fetch Issue data"
              exit 1
            }
            
            echo "Issue data fetched successfully"
            
            echo "context-type=issue" >> $GITHUB_OUTPUT
          fi
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          echo "Files created:"
          ls -la *.json *.txt 2>/dev/null || echo "No json/txt files found"

      - name: Run AI review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MAX_TOKENS: ${{ needs.prepare-review.outputs.max-tokens }}
          REVIEW_MODE: ${{ needs.prepare-review.outputs.review-mode }}
        run: |
          cat > ai_review.py << 'EOF'
          import os
          import sys
          import json
          import anthropic
          import openai
          from github import Github
          
          # è¨­å®š
          issue_num = "${{ inputs.issue-number }}"
          review_mode = os.getenv("REVIEW_MODE", "issue")
          max_tokens = int(os.getenv("MAX_TOKENS", "2000"))
          
          # APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
          anthropic_client = anthropic.Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))
          openai_client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
          
          # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿è¾¼ã¿
          if review_mode == "pr":
              try:
                  with open("pr_data.json", "r") as f:
                      pr_data = json.load(f)
              except FileNotFoundError:
                  print("Error: pr_data.json not found")
                  sys.exit(1)
              except json.JSONDecodeError as e:
                  print(f"Error: Invalid JSON in pr_data.json: {e}")
                  sys.exit(1)
              
              # diff.txtã®èª­ã¿è¾¼ã¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
              try:
                  with open("diff.txt", "r") as f:
                      diff_content = f.read()[:8000]  # æœ€å¤§8000æ–‡å­—
              except FileNotFoundError:
                  print("Warning: diff.txt not found, continuing without diff")
                  diff_content = "Diff not available"
              
              # changed_files.txtã®èª­ã¿è¾¼ã¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
              try:
                  with open("changed_files.txt", "r") as f:
                      content = f.read().strip()
                      changed_files = content.split("\n") if content else []
              except FileNotFoundError:
                  print("Warning: changed_files.txt not found")
                  changed_files = []
              
              # PRæƒ…å ±ã®æ¤œè¨¼
              title = pr_data.get('title', 'No title')
              author_data = pr_data.get('author')
              author = author_data.get('login', 'Unknown') if author_data else 'Unknown'
              additions = pr_data.get('additions', 0)
              deletions = pr_data.get('deletions', 0)
              body = pr_data.get('body') or 'No description provided'
              
              context = f"""
              PR #{issue_num}: {title}
              Author: {author}
              Changes: +{additions} -{deletions} in {len(changed_files)} files
              
              Description:
              {body}
              
              Changed files:
              {', '.join(changed_files[:20])}{'...' if len(changed_files) > 20 else ''}
              
              Diff preview:
              {diff_content}
              """
          else:
              try:
                  with open("issue_data.json", "r") as f:
                      issue_data = json.load(f)
              except FileNotFoundError:
                  print("Error: issue_data.json not found")
                  sys.exit(1)
              except json.JSONDecodeError as e:
                  print(f"Error: Invalid JSON in issue_data.json: {e}")
                  sys.exit(1)
              
              # Issueæƒ…å ±ã®æ¤œè¨¼
              title = issue_data.get('title', 'No title')
              author_data = issue_data.get('author')
              author = author_data.get('login', 'Unknown') if author_data else 'Unknown'
              body = issue_data.get('body') or 'No description provided'
              comments = issue_data.get('comments', [])
              
              context = f"""
              Issue #{issue_num}: {title}
              Author: {author}
              
              Description:
              {body}
              
              Comments: {len(comments)}
              """
          
          # 4ã¤ã®ãƒ­ãƒ¼ãƒ«ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæ”¹å–„ç‰ˆï¼‰
          roles = [
              {
                  "name": "Security",
                  "emoji": "ğŸ”’",
                  "focus": "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã€ãƒ‡ãƒ¼ã‚¿ä¿è­·ã€èªè¨¼èªå¯",
                  "max_items": 3,
                  "priority": "high"
              },
              {
                  "name": "QA",
                  "emoji": "ğŸ§ª",
                  "focus": "ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã€å›å¸°ãƒªã‚¹ã‚¯",
                  "max_items": 3,
                  "priority": "medium"
              },
              {
                  "name": "Architecture",
                  "emoji": "ğŸ—ï¸",
                  "focus": "ã‚³ãƒ¼ãƒ‰å“è³ªã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€ä¿å®ˆæ€§",
                  "max_items": 2,
                  "priority": "medium"
              },
              {
                  "name": "Product",
                  "emoji": "ğŸ“±",
                  "focus": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾¡å€¤ã€è¦ä»¶é©åˆæ€§ã€å®Ÿè£…ã®å¦¥å½“æ€§",
                  "max_items": 2,
                  "priority": "low"
              }
          ]
          
          reviews = []
          
          # å„ãƒ­ãƒ¼ãƒ«ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½
          for role in roles:
              prompt = f"""
              {role['name']}ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã€ä»¥ä¸‹ã®{'PR' if review_mode == 'pr' else 'Issue'}ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
              è¦³ç‚¹: {role['focus']}
              
              {context}
              
              é‡è¦ãª{'å•é¡Œ' if role['priority'] == 'high' else 'æ”¹å–„ç‚¹'}ã‚’æœ€å¤§{role['max_items']}å€‹æŒ™ã’ã¦ãã ã•ã„ã€‚
              {'- å¿…ãšã‚³ãƒ¼ãƒ‰ä¾‹ã‚’å«ã‚ã‚‹ã“ã¨' if review_mode == 'pr' else ''}
              - å®Ÿè£…ã®ç¾å®Ÿæ€§ã‚’è€ƒæ…®ã™ã‚‹ã“ã¨ï¼ˆVercel Functionsç’°å¢ƒï¼‰
              - ç°¡æ½”ã«ï¼ˆå„é …ç›®2-3è¡Œä»¥å†…ï¼‰
              
              ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
              {'ğŸš¨' if role['priority'] == 'high' else 'âš ï¸' if role['priority'] == 'medium' else 'â„¹ï¸'} é …ç›®1: å…·ä½“çš„ãªå•é¡Œã¨è§£æ±ºç­–
              {'```' if review_mode == 'pr' else ''}
              """
              
              try:
                  if role['name'] in ['Security', 'Architecture']:
                      # Claudeä½¿ç”¨ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼‰
                      response = anthropic_client.messages.create(
                          model=os.getenv("ANTHROPIC_MODEL"),
                          max_tokens=300,  # ç°¡æ½”ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãŸã‚å‰Šæ¸›
                          temperature=0.2,  # ã‚ˆã‚Šä¸€è²«æ€§ã®ã‚ã‚‹å‡ºåŠ›
                          messages=[{"role": "user", "content": prompt}]
                      )
                      review_text = response.content[0].text
                  else:
                      # OpenAIä½¿ç”¨ï¼ˆQAã¨Productï¼‰
                      response = openai_client.chat.completions.create(
                          model=os.getenv("OPENAI_MODEL"),
                          max_tokens=300,
                          temperature=0.2,
                          messages=[{"role": "user", "content": prompt}]
                      )
                      review_text = response.choices[0].message.content
                  
                  reviews.append({
                      "role": role['name'],
                      "emoji": role['emoji'],
                      "priority": role['priority'],
                      "content": review_text.strip()
                  })
              except Exception as e:
                  print(f"Error in {role['name']} review: {e}")
                  reviews.append({
                      "role": role['name'],
                      "emoji": role['emoji'],
                      "priority": role['priority'],
                      "content": f"ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒ©ãƒ¼: {str(e)}"
                  })
          
          # å„ªå…ˆåº¦åˆ¥ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ•´ç†
          high_priority = [r for r in reviews if r['priority'] == 'high']
          medium_priority = [r for r in reviews if r['priority'] == 'medium']
          low_priority = [r for r in reviews if r['priority'] == 'low']
          
          summary_prompt = f"""
          ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ã€é–‹ç™ºè€…ãŒå³åº§ã«è¡Œå‹•ã§ãã‚‹å½¢ã«ã¾ã¨ã‚ã¦ãã ã•ã„ï¼š
          
          é«˜å„ªå…ˆåº¦ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰:
          {chr(10).join([r['content'] for r in high_priority])}
          
          ä¸­å„ªå…ˆåº¦ï¼ˆå“è³ªï¼‰:
          {chr(10).join([r['content'] for r in medium_priority])}
          
          ä½å„ªå…ˆåº¦ï¼ˆæ”¹å–„ï¼‰:
          {chr(10).join([r['content'] for r in low_priority])}
          
          å‡ºåŠ›å½¢å¼ï¼ˆ100æ–‡å­—ä»¥å†…ã§å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰:
          ## åˆ¤å®š: [âœ… æ‰¿èªå¯èƒ½ / âš ï¸ ä¿®æ­£å¾Œæ‰¿èª / ğŸš« è¦ä¿®æ­£]
          ## å¿…é ˆä¿®æ­£: æœ€å¤§3é …ç›®ï¼ˆã‚³ãƒ¼ãƒ‰ä¾‹ä»˜ãï¼‰
          ## æ¨å¥¨äº‹é …: æœ€å¤§2é …ç›®ï¼ˆåˆ¥PRå¯ï¼‰
          
          Vercel Functionsç’°å¢ƒã‚’è€ƒæ…®ã—ã€å®Ÿè£…å¯èƒ½ãªææ¡ˆã®ã¿å«ã‚ã‚‹ã“ã¨ã€‚
          """
          
          try:
              summary_response = anthropic_client.messages.create(
                  model=os.getenv("ANTHROPIC_MODEL"),
                  max_tokens=500,  # ç°¡æ½”ãªã‚µãƒãƒªãƒ¼ã®ãŸã‚å‰Šæ¸›
                  temperature=0.1,  # ã‚ˆã‚Šæ±ºå®šçš„ãªå‡ºåŠ›
                  messages=[{"role": "user", "content": summary_prompt}]
              )
              summary = summary_response.content[0].text.strip()
          except Exception as e:
              summary = f"ã‚µãƒãƒªãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {str(e)}"
          
          # æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆä½œæˆï¼ˆæ”¹å–„ç‰ˆï¼‰
          final_report = f"""## ğŸ¤– AI Code Review - #{issue_num}
          
          {summary}
          
          ---
          
          ### è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼
          
          {"#### ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£" + chr(10) + chr(10).join([r['content'] for r in high_priority]) if high_priority else ""}
          
          {"#### ğŸ§ª å“è³ªãƒ»ãƒ†ã‚¹ãƒˆ" + chr(10) + chr(10).join([r['content'] for r in medium_priority if r['role'] == 'QA']) if any(r['role'] == 'QA' for r in medium_priority) else ""}
          
          {"#### ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£" + chr(10) + chr(10).join([r['content'] for r in medium_priority if r['role'] == 'Architecture']) if any(r['role'] == 'Architecture' for r in medium_priority) else ""}
          
          ---
          <sub>ğŸ¤– Reviewed by AI ({', '.join([f"{r['role']}:{'Claude' if r['role'] in ['Security', 'Architecture'] else 'GPT-4'}" for r in reviews])}) | [æ”¹å–„ææ¡ˆã¯ã“ã¡ã‚‰](https://github.com/NFTTechnology/Pu5h-Remind/issues/new)</sub>
          """
          
          # ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
          with open("review_report.md", "w", encoding="utf-8") as f:
              f.write(final_report)
          
          print("AI review completed successfully")
          EOF
          
          python ai_review.py

      - name: Post review comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’æŠ•ç¨¿
          if [[ -f "review_report.md" ]]; then
            REPORT=$(cat review_report.md)
            
            if [[ "${{ needs.prepare-review.outputs.is-pr }}" == "true" ]]; then
              gh pr comment ${{ inputs.issue-number }} --repo ${{ github.repository }} --body "$REPORT"
            else
              gh issue comment ${{ inputs.issue-number }} --repo ${{ github.repository }} --body "$REPORT"
            fi
            
            echo "âœ… Review posted successfully"
          else
            echo "âŒ Review report not found"
            exit 1
          fi

      - name: Add labels based on review
        if: success()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã«åŸºã¥ã„ã¦ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          ISSUE_NUM="${{ inputs.issue-number }}"
          
          # å„ªå…ˆåº¦ãƒ©ãƒ™ãƒ«
          if [[ "${{ inputs.priority }}" == "high" ]]; then
            gh issue edit $ISSUE_NUM --repo ${{ github.repository }} --add-label "priority:high" || true
          fi
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†ãƒ©ãƒ™ãƒ«
          gh issue edit $ISSUE_NUM --repo ${{ github.repository }} --add-label "ai-reviewed" || true