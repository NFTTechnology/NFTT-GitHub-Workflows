# ãƒ¢ãƒãƒ¬ãƒå¯¾å¿œã®å®Ÿè£…ä¾‹
# è¤‡æ•°ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå«ã¾ã‚Œã‚‹ãƒ¢ãƒãƒ¬ãƒã§ã®ä½¿ç”¨æ–¹æ³•

name: Monorepo AI Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      # ç‰¹å®šã®ãƒ‘ã‚¹ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      - 'packages/**'
      - 'apps/**'
      - '!**/*.md'  # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯é™¤å¤–

jobs:
  # å¤‰æ›´ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ¤œå‡º
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      changes: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/web/**'
              - 'packages/ui/**'
            backend:
              - 'apps/api/**'
              - 'packages/core/**'
            mobile:
              - 'apps/mobile/**'
              - 'packages/mobile-ui/**'
      
      - id: set-matrix
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
          changes=$(echo '${{ toJSON(steps.filter.outputs) }}' | jq -c '[to_entries[] | select(.value == "true") | .key]')
          echo "matrix={\"project\":$changes}" >> $GITHUB_OUTPUT

  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«AIãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
  review-project:
    needs: detect-changes
    if: needs.detect-changes.outputs.changes != '[]'
    strategy:
      matrix: ${{ fromJSON(needs.detect-changes.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥è¨­å®š
        id: config
        run: |
          case "${{ matrix.project }}" in
            frontend)
              echo "review_type=balanced" >> $GITHUB_OUTPUT
              echo "focus=UI/UX,ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹,ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£" >> $GITHUB_OUTPUT
              ;;
            backend)
              echo "review_type=detailed" >> $GITHUB_OUTPUT
              echo "focus=ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£,APIè¨­è¨ˆ,ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹" >> $GITHUB_OUTPUT
              ;;
            mobile)
              echo "review_type=balanced" >> $GITHUB_OUTPUT
              echo "focus=ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹,ãƒãƒƒãƒ†ãƒªãƒ¼æ¶ˆè²»,ãƒã‚¤ãƒ†ã‚£ãƒ–é€£æº" >> $GITHUB_OUTPUT
              ;;
          esac
      
      - name: PR Review - ${{ matrix.project }}
        uses: NFTTechnology/NFTT-GitHub-Workflows/.github/workflows/reusable-pr-review.yml@main
        with:
          pr_number: ${{ github.event.pull_request.number }}
          repository: ${{ github.repository }}
          review_type: ${{ steps.config.outputs.review_type }}
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ãƒ‘ã‚¹ã®ã¿ãƒ¬ãƒ“ãƒ¥ãƒ¼
          path_filter: ${{ matrix.project }}
          custom_prompt: |
            ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯${{ matrix.project }}ã§ã™ã€‚
            ç‰¹ã«ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š
            ${{ steps.config.outputs.focus }}
        secrets: inherit

  # çµ±åˆã‚µãƒãƒªãƒ¼ã®ä½œæˆ
  summary:
    needs: review-project
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: çµ±åˆãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼
        uses: actions/github-script@v7
        with:
          script: |
            const projects = ${{ toJSON(needs.detect-changes.outputs.matrix) }};
            
            let summary = `## ğŸ“Š ãƒ¢ãƒãƒ¬ãƒ AI ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼\n\n`;
            summary += `### å¤‰æ›´ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ\n`;
            
            for (const project of projects.project) {
              summary += `- âœ… ${project}\n`;
            }
            
            summary += `\nå„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ä¸Šè¨˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

# ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒã‚¤ãƒ³ãƒˆï¼š
# 1. paths ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆã«åˆã‚ã›ã¦èª¿æ•´
# 2. review_type ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é‡è¦åº¦ã«å¿œã˜ã¦è¨­å®š
# 3. custom_prompt ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®è¦³ç‚¹ã‚’è¿½åŠ 