# ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã•ã‚ŒãŸå®Ÿè£…ä¾‹
# ç„¡æ–™æ å†…ã§æœ€å¤§é™ã®åŠ¹æœã‚’å¾—ã‚‹ãŸã‚ã®è¨­å®š

name: Cost-Optimized AI Review

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

# æœˆé–“ã®å®Ÿè¡Œå›æ•°ã‚’åˆ¶é™
concurrency:
  group: ai-review-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # æœˆé–“äºˆç®—è¨­å®šï¼ˆãƒ‰ãƒ«ï¼‰
  MONTHLY_BUDGET: 10
  # ç¾åœ¨ã®ä½¿ç”¨é‡ã‚’è¿½è·¡
  USAGE_FILE: .github/ai-usage.json

jobs:
  # ã‚³ã‚¹ãƒˆç¢ºèª
  check-budget:
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.proceed }}
      remaining_budget: ${{ steps.check.outputs.remaining }}
    steps:
      - uses: actions/checkout@v4
      
      - name: ä½¿ç”¨é‡ç¢ºèª
        id: check
        run: |
          # ä½¿ç”¨é‡ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆæœŸåŒ–
          if [ ! -f "$USAGE_FILE" ]; then
            echo '{"month":"'$(date +%Y-%m)'","cost":0,"count":0}' > $USAGE_FILE
          fi
          
          # ç¾åœ¨ã®ä½¿ç”¨é‡ã‚’ç¢ºèª
          current_month=$(date +%Y-%m)
          usage=$(cat $USAGE_FILE)
          usage_month=$(echo $usage | jq -r '.month')
          
          # æœˆãŒå¤‰ã‚ã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
          if [ "$usage_month" != "$current_month" ]; then
            echo '{"month":"'$current_month'","cost":0,"count":0}' > $USAGE_FILE
            usage=$(cat $USAGE_FILE)
          fi
          
          current_cost=$(echo $usage | jq -r '.cost')
          remaining=$(echo "$MONTHLY_BUDGET - $current_cost" | bc)
          
          # äºˆç®—ç¢ºèª
          if (( $(echo "$remaining > 0" | bc -l) )); then
            echo "proceed=true" >> $GITHUB_OUTPUT
            echo "remaining=$remaining" >> $GITHUB_OUTPUT
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
            echo "remaining=0" >> $GITHUB_OUTPUT
          fi

  # Issueåˆ†æï¼ˆã‚³ã‚¹ãƒˆæœ€é©åŒ–ç‰ˆï¼‰
  analyze-issue:
    needs: check-budget
    if: |
      needs.check-budget.outputs.can_proceed == 'true' &&
      github.event_name == 'issue_comment' &&
      startsWith(github.event.comment.body, '/analyze-budget')
    uses: NFTTechnology/NFTT-GitHub-Workflows/.github/workflows/reusable-3ai-issue-analyzer-v5.yml@main
    with:
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
      issue_body: ${{ github.event.issue.body }}
      repository: ${{ github.repository }}
      # v5ã®ã‚³ã‚¹ãƒˆæœ€é©åŒ–æ©Ÿèƒ½ã‚’æœ€å¤§é™æ´»ç”¨
      enable_cost_optimization: true
      models: |
        {
          "claude": "claude-3-5-haiku-20241022",
          "openai": "gpt-4o-mini",
          "gemini": "gemini-1.5-flash"
        }
    secrets: inherit

  # PRãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè»½é‡ç‰ˆï¼‰
  review-pr:
    needs: check-budget
    if: |
      needs.check-budget.outputs.can_proceed == 'true' &&
      github.event_name == 'pull_request' &&
      github.event.pull_request.additions < 500
    runs-on: ubuntu-latest
    steps:
      - name: ç°¡æ˜“ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        run: |
          # åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆAIã‚’ä½¿ã‚ãªã„ï¼‰
          echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯ä¸­..."
          
          # å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
          patterns=(
            "password.*=.*['\"]"
            "api[_-]?key.*=.*['\"]"
            "token.*=.*['\"]"
            "secret.*=.*['\"]"
          )
          
          found_issues=false
          for pattern in "${patterns[@]}"; do
            if gh pr diff ${{ github.event.pull_request.number }} | grep -iE "$pattern"; then
              found_issues=true
              echo "âš ï¸ æ½œåœ¨çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ: $pattern"
            fi
          done
          
          if [ "$found_issues" = true ]; then
            echo "trigger_full_review=true" >> $GITHUB_ENV
          fi
      
      - name: AI ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå¿…è¦æ™‚ã®ã¿ï¼‰
        if: env.trigger_full_review == 'true'
        uses: NFTTechnology/NFTT-GitHub-Workflows/.github/workflows/reusable-pr-review.yml@main
        with:
          pr_number: ${{ github.event.pull_request.number }}
          repository: ${{ github.repository }}
          review_type: 'quick'  # æœ€é€Ÿãƒ»æœ€å®‰å€¤
          max_diff_lines: 1000  # å·®åˆ†ã‚’åˆ¶é™
          # æœ€ã‚‚å®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
          models: |
            {
              "claude": "claude-3-5-haiku-20241022",
              "openai": "gpt-4o-mini"
            }
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ã¿ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
          focus_areas: "security"
        secrets: inherit

  # ä½¿ç”¨é‡æ›´æ–°
  update-usage:
    needs: [analyze-issue, review-pr]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ä½¿ç”¨é‡è¨˜éŒ²
        run: |
          # æ¨å®šã‚³ã‚¹ãƒˆï¼ˆå®Ÿéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã«åŸºã¥ã„ã¦èª¿æ•´ãŒå¿…è¦ï¼‰
          estimated_cost=0.02  # Issueåˆ†æã¾ãŸã¯PRãƒ¬ãƒ“ãƒ¥ãƒ¼1å›ã‚ãŸã‚Š
          
          # ä½¿ç”¨é‡ã‚’æ›´æ–°
          current=$(cat $USAGE_FILE)
          new_cost=$(echo "$current" | jq ".cost + $estimated_cost")
          new_count=$(echo "$current" | jq ".count + 1")
          
          echo "$current" | jq ".cost = $new_cost | .count = $new_count" > $USAGE_FILE
          
          # ã‚³ãƒŸãƒƒãƒˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add $USAGE_FILE
          git commit -m "chore: AIä½¿ç”¨é‡ã‚’æ›´æ–° [skip ci]" || true
          git push || true

  # äºˆç®—ã‚¢ãƒ©ãƒ¼ãƒˆ
  budget-alert:
    needs: check-budget
    if: needs.check-budget.outputs.remaining_budget < 2
    runs-on: ubuntu-latest
    steps:
      - name: äºˆç®—è­¦å‘ŠIssueä½œæˆ
        uses: actions/github-script@v7
        with:
          script: |
            const remaining = ${{ needs.check-budget.outputs.remaining_budget }};
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âš ï¸ AIäºˆç®—æ®‹é«˜ãŒå°‘ãªããªã£ã¦ã„ã¾ã™',
              body: `ç¾åœ¨ã®æ®‹é«˜: $${remaining}\n\næœˆé–“äºˆç®—ã®90%ä»¥ä¸Šã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚`,
              labels: ['budget-alert', 'ai-workflows']
            });

# ã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãƒã‚¤ãƒ³ãƒˆï¼š
# 1. å®Ÿè¡Œæ¡ä»¶ã‚’å³å¯†ã«è¨­å®šï¼ˆå°ã•ãªPRã®ã¿ã€ç‰¹å®šã®ã‚³ãƒãƒ³ãƒ‰ã®ã¿ï¼‰
# 2. æœ€ã‚‚å®‰ä¾¡ãªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ï¼ˆHaikuã€GPT-4o-miniï¼‰
# 3. å·®åˆ†ã‚µã‚¤ã‚ºã‚’åˆ¶é™
# 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ­£è¦è¡¨ç¾ã§äº‹å‰ãƒã‚§ãƒƒã‚¯
# 5. æœˆé–“äºˆç®—ã‚’è¨­å®šã—ã¦è‡ªå‹•åœæ­¢